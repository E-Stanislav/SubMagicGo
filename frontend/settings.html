<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Whisper: управление моделями</title>
  <style>
    body {
      background: #232324;
      color: #fff;
      font-family: 'Nunito', 'Inter', Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
    }
    .settings-root {
      max-width: 820px;
      margin: 0 auto;
      padding: 32px 16px 0 16px;
    }
    .settings-title {
      font-size: 2.7rem;
      font-weight: 800;
      margin: 24px 0 0 0;
      letter-spacing: -1px;
    }
    .settings-sub {
      font-size: 1.25rem;
      color: #e0e0e0;
      margin-bottom: 36px;
      margin-top: 0;
      font-weight: 400;
    }
    .section {
      margin-bottom: 38px;
    }
    .section-title {
      font-size: 1.15rem;
      font-weight: 600;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .section-title svg {
      width: 22px;
      height: 22px;
      vertical-align: middle;
      color: #b3d4fc;
    }
    .download-row {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #181c20;
      border-radius: 10px;
      padding: 16px 18px;
      max-width: 520px;
      margin-bottom: 8px;
    }
    .download-row label {
      font-size: 1.08rem;
      margin-right: 8px;
      font-weight: 500;
    }
    .download-row select {
      background: #23272b;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 7px 16px;
      font-size: 1.08rem;
      margin-right: 8px;
      outline: none;
    }
    .btn {
      background: #1877f2;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 22px;
      font-size: 1.08rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px #0002;
      transition: background 0.18s, box-shadow 0.18s, transform 0.18s;
      outline: none;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .btn:disabled {
      background: #3a4a5a;
      cursor: default;
      color: #b0b0b0;
    }
    .btn:hover:not(:disabled) {
      background: #145dc0;
    }
    .btn-delete {
      background: #444e5a;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 7px 18px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      margin-right: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.18s;
    }
    .btn-delete:hover {
      background: #c0392b;
      color: #fff;
    }
    .divider {
      border: none;
      border-top: 2px solid #393939;
      margin: 38px 0 32px 0;
    }
    .downloaded-title {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 24px;
      margin-top: 0;
    }
    .models-list {
      display: flex;
      flex-direction: column;
      gap: 22px;
    }
    .model-card {
      background: #16233a;
      border-radius: 18px;
      padding: 26px 32px;
      display: flex;
      align-items: center;
      gap: 22px;
      box-shadow: 0 2px 16px #0003;
      min-width: 0;
      position: relative;
    }
    .model-icon {
      width: 36px;
      height: 36px;
      color: #4fa3ff;
      flex-shrink: 0;
    }
    .model-name {
      font-size: 1.25rem;
      font-weight: 700;
      color: #fff;
      margin-right: 18px;
      word-break: break-all;
    }
    .model-selected {
      color: #4fa3ff;
      margin-left: auto;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .model-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .model-size {
      color: #b3d4fc;
      font-size: 1.05rem;
      margin-right: 18px;
    }
    .empty-list {
      color: #aaa;
      font-size: 1.15rem;
      margin-top: 12px;
      margin-bottom: 24px;
    }
    @media (max-width: 700px) {
      .settings-root { padding: 18px 2vw 0 2vw; }
      .model-card { flex-direction: column; align-items: flex-start; padding: 18px 12px; gap: 10px; }
      .download-row { flex-direction: column; align-items: flex-start; gap: 10px; padding: 12px 8px; }
    }
  </style>
</head>
<body>
  <div class="settings-root">
    <div class="settings-sub">Управление моделями Whisper</div>
    <div class="settings-title">Whisper: управление моделями</div>

    <div class="section">
      <div class="section-title">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
        Доступные модели для скачивания
      </div>
      <div class="download-row">
        <label for="modelSelect">Модель:</label>
        <select id="modelSelect"></select>
        <button id="downloadBtn" class="btn">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="20" height="20"><path d="M12 5v14m7-7H5"/></svg>
          Скачать
        </button>
      </div>
      <div id="downloadProgress" style="margin-top:10px; color:#4fa3ff; font-size:1.08rem; display:none;"></div>
    </div>

    <hr class="divider" />

    <div class="downloaded-title">Скачанные модели</div>
    <div id="modelsList" class="models-list"></div>
    <div id="emptyList" class="empty-list" style="display:none;">Нет загруженных моделей Whisper</div>
  </div>
  <script>
    // --- Данные и состояния ---
    let availableModels = [];
    let downloadedModels = [];
    let selectedModel = null;
    let activeModel = localStorage.getItem('whisperModel') || null;
    let downloading = false;
    let downloadProgress = 0;

    // --- SVG-иконки ---
    const iconModel = `<svg class='model-icon' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><rect x='3' y='7' width='18' height='13' rx='3'/><path d='M16 3v4M8 3v4'/></svg>`;
    const iconCheck = `<svg fill='none' stroke='#4fa3ff' stroke-width='3' viewBox='0 0 24 24' width='28' height='28'><path d='M5 13l4 4L19 7'/></svg>`;
    const iconDelete = `<svg fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24' width='20' height='20'><rect x='3' y='6' width='18' height='14' rx='2'/><path d='M9 10v4M15 10v4M10 6V4h4v2'/></svg>`;

    // --- DOM ---
    const modelSelect = document.getElementById('modelSelect');
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadProgressDiv = document.getElementById('downloadProgress');
    const modelsListDiv = document.getElementById('modelsList');
    const emptyListDiv = document.getElementById('emptyList');

    // --- Загрузка данных ---
    async function loadModels() {
      // Получаем список доступных моделей для скачивания и скачанных моделей
      try {
        const all = await window.go.main.App.ListModels();
        availableModels = all.filter(m => !m.local);
        downloadedModels = all.filter(m => m.local);
        renderAvailableModels();
        renderDownloadedModels();
      } catch (e) {
        modelsListDiv.innerHTML = '';
        emptyListDiv.style.display = 'block';
        emptyListDiv.textContent = 'Ошибка загрузки моделей Whisper';
      }
    }

    // --- Рендер выпадающего списка и кнопки скачивания ---
    function renderAvailableModels() {
      modelSelect.innerHTML = '';
      if (availableModels.length === 0) {
        modelSelect.disabled = true;
        downloadBtn.disabled = true;
        downloadBtn.textContent = 'Нет новых моделей';
        return;
      }
      modelSelect.disabled = false;
      downloadBtn.disabled = false;
      availableModels.forEach((m, i) => {
        const opt = document.createElement('option');
        opt.value = m.name;
        opt.textContent = `${m.name} (${(m.size/1024/1024).toFixed(0)} MB)`;
        modelSelect.appendChild(opt);
      });
      selectedModel = modelSelect.value = availableModels[0].name;
      downloadBtn.innerHTML = `<svg fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24' width='20' height='20'><path d='M12 5v14m7-7H5'/></svg> Скачать`;
    }

    modelSelect.onchange = e => {
      selectedModel = e.target.value;
    };

    downloadBtn.onclick = async () => {
      if (!selectedModel || downloading) return;
      downloading = true;
      downloadBtn.disabled = true;
      downloadBtn.innerHTML = 'Загрузка...';
      downloadProgressDiv.style.display = 'block';
      downloadProgressDiv.textContent = '0%';
      try {
        await window.go.main.App.DownloadModel(selectedModel);
        // Прогресс обновится через событие
      } catch (e) {
        downloadProgressDiv.textContent = 'Ошибка загрузки';
      } finally {
        downloading = false;
        loadModels();
        downloadProgressDiv.style.display = 'none';
      }
    };

    // --- Событие прогресса загрузки ---
    window.runtime && window.runtime.EventsOn && window.runtime.EventsOn("modelDownloadProgress", data => {
      if (data.name === selectedModel) {
        downloadProgressDiv.style.display = 'block';
        downloadProgressDiv.textContent = data.percent + '%';
        if (data.percent >= 100) {
          downloadProgressDiv.style.display = 'none';
        }
      }
    });

    // --- Рендер скачанных моделей ---
    function renderDownloadedModels() {
      modelsListDiv.innerHTML = '';
      if (downloadedModels.length === 0) {
        emptyListDiv.style.display = 'block';
        return;
      }
      emptyListDiv.style.display = 'none';
      downloadedModels.forEach(model => {
        const card = document.createElement('div');
        card.className = 'model-card';
        card.innerHTML = `
          ${iconModel}
          <span class='model-name'>${model.name}</span>
          <span class='model-size'>${(model.size/1024/1024).toFixed(0)} MB</span>
          <div class='model-actions'>
            <button class='btn-delete' title='Удалить модель'>${iconDelete} Удалить</button>
          </div>
          <span class='model-selected' style='${activeModel===model.name ? '' : 'opacity:0;'}' title='Активная модель'>${iconCheck}</span>
        `;
        // Клик по карточке — сделать модель активной
        card.onclick = e => {
          if (e.target.closest('.btn-delete')) return;
          activeModel = model.name;
          localStorage.setItem('whisperModel', activeModel);
          renderDownloadedModels();
        };
        // Кнопка удалить
        card.querySelector('.btn-delete').onclick = async (e) => {
          e.stopPropagation();
          if (confirm(`Удалить модель ${model.name}?`)) {
            await window.go.main.App.DeleteModel(model.name);
            loadModels();
          }
        };
        modelsListDiv.appendChild(card);
      });
    }

    // --- Инициализация ---
    window.onload = loadModels;
  </script>
</body>
</html> 