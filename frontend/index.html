<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SubMagicGo — Video Player</title>
    
    <!-- Шрифты и иконки -->
    <link rel="preconnect" href="https://fonts.gstatic.com"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

    <style>
        /* RESET */
        *,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }
        html, body { height:100%; min-width:720px; min-height:720px; }
        body {
            min-height: 100vh;
        }
        button { font:inherit; }

        /* DESIGN TOKENS */
        :root {
            --bg: #f7f7f7;
            --surface: #ffffff;
            --surface-alt: #ececec;
            --primary: #4fa3ff;
            --primary-hover: #3578c6;
            --danger: #e74c3c;
            --danger-hover: #c0392b;
            --text: #222222;
            --text-muted: #6b7280;
            --border: #dadada;
            --radius: 12px;
            --shadow-sm: 0 2px 12px #0001;
            --shadow-md: 0 4px 18px #0002;
            --transition: .24s cubic-bezier(.4,0,.2,1);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #1f2937;
                --surface: #374151;
                --surface-alt: #4b5563;
                --primary: #60a5fa;
                --primary-hover: #3b82f6;
                --danger: #f87171;
                --danger-hover: #ef4444;
                --text: #f3f4f6;
                --text-muted: #9ca3af;
                --border: #4b5563;
                --shadow-sm: 0 2px 12px #0005;
                --shadow-md: 0 4px 18px #0006;
            }
        }

        /* LAYOUT */
        body {
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
        }
        header {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: none;
            margin-inline: auto;
            padding: clamp(1rem, 2vw, 2rem);
            min-height: 0;
        }
        .container {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: 100%;
            max-width: none;
            margin: 0 auto;
        }

        /* Components */
        .menu-btn {
            background: var(--surface-alt);
            border: none;
            border-radius: var(--radius) var(--radius) 0 0;
            padding: .5rem 1.25rem;
            font-size: 1.05rem;
            color: var(--text-muted);
            font-weight: 500;
            cursor: pointer;
            transition: background var(--transition), color var(--transition);
        }
        .menu-btn.active {
            background: var(--surface);
            color: var(--text);
            font-weight: 600;
        }

        #editorPanel {
            position: relative;
            width: 100%;
            min-height: 520px;
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 0;
            max-width: none;
        }
        .dropzone {
            position: static;
            width: 95vw;
            max-width: none;
            min-width: 0;
            margin: 0 auto;
            height: 100%;
            min-height: 520px;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            background: var(--surface);
            border: 2.5px dashed var(--border);
            border-radius: var(--radius);
            color: var(--text-muted);
            transition: all var(--transition);
            cursor: pointer;
            user-select: none;
            font-size: 1.45rem;
            padding: 3rem 2rem;
            box-sizing: border-box;
        }
        .dropzone.dragover {
            border-color: var(--primary);
            color: var(--primary);
            background: color-mix(in srgb, var(--primary) 10%, transparent);
            box-shadow: var(--shadow-md);
        }
        #video, #videoTitle, #controls {
            position: relative;
            z-index: 3;
        }

        video {
            width: 100%;
            height: auto;
            border-radius: var(--radius);
            background: #000;
        }

        .controls {
            display: grid;
            grid-auto-flow: column;
            gap: clamp(.5rem, 1.5vw, 1.25rem);
            justify-content: center;
            margin-top: 2rem;
            width: 100%;
        }
        @media (max-width: 700px) {
            .controls {
                grid-auto-flow: row;
                grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr));
            }
        }
        .btn {
            appearance: none;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: var(--radius);
            padding: .9rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: .3px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
        }
        .btn:hover, .btn:focus-visible {
            background: var(--primary-hover);
            transform: translateY(-2px) scale(1.03);
            box-shadow: var(--shadow-md);
        }
        .btn--danger {
            background: var(--danger);
        }
        .btn--danger:hover, .btn--danger:focus-visible {
            background: var(--danger-hover);
        }

        .sr-only {
            position: absolute !important;
            width: 1px; height: 1px;
            padding: 0; margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

        /* --- Whisper Settings Modern UI --- */
        .whisper-section {
            width: 100%;
            max-width: 520px;
            margin: 0 auto 2.2rem auto;
            background: var(--surface);
            border-radius: 18px;
            box-shadow: var(--shadow-md);
            padding: 2rem 1.5rem 1.5rem 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }
        .whisper-section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.2rem;
            letter-spacing: -0.5px;
        }
        .whisper-download-row {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 0.5rem;
        }
        .whisper-download-row label {
            font-size: 1.08rem;
            font-weight: 500;
        }
        .whisper-download-row select {
            background: var(--surface-alt);
            color: var(--text);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 1rem;
            font-weight: 500;
            outline: none;
            min-width: 200px;
            cursor: pointer;
            transition: all var(--transition);
            box-shadow: var(--shadow-sm);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg fill='%234fa3ff' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 40px;
        }
        .whisper-download-row select:hover {
            border-color: var(--primary);
            background-color: color-mix(in srgb, var(--primary) 5%, var(--surface-alt));
            box-shadow: var(--shadow-md);
        }
        .whisper-download-row select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent);
        }
        .whisper-download-row select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .whisper-download-row select option {
            background: var(--surface);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 8px;
            margin: 2px 0;
        }
        .whisper-download-row select option:hover, 
        .whisper-download-row select option:focus {
            background: var(--primary);
            color: #fff;
        }
        .whisper-download-btn {
            background: var(--primary);
            color: #fff;
            font-size: 1.08rem;
            font-weight: 700;
            border-radius: 12px;
            padding: 0.6em 1.7em;
            border: none;
            cursor: pointer;
            transition: background 0.18s;
        }
        .whisper-download-btn:disabled {
            background: #b3d4fc;
            color: #fff;
            cursor: default;
        }
        .whisper-download-btn:not(:disabled):hover {
            background: var(--primary-hover);
        }
        .whisper-progress {
            background: #4fa3ff33;
            color: var(--primary);
            font-size: 1em;
            border-radius: 8px;
            width: 0;
            height: 22px;
            line-height: 22px;
            transition: width 0.2s;
            display: none;
            text-align: center;
            margin-left: 10px;
            min-width: 60px;
        }
        .whisper-divider {
            border: none;
            border-top: 2px solid var(--surface-alt);
            margin: 2.5rem 0 2rem 0;
        }
        .whisper-models-list {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.1rem;
        }
        .whisper-model-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface-alt);
            border-radius: 14px;
            box-shadow: 0 2px 12px #0001;
            padding: 0.9rem 1.2rem;
            transition: box-shadow 0.18s, background 0.18s;
            position: relative;
        }
        .whisper-model-card:hover {
            box-shadow: 0 6px 24px #0002;
            background: color-mix(in srgb, var(--primary) 7%, var(--surface-alt));
        }
        .whisper-model-info {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .whisper-model-icon {
            width: 26px;
            height: 26px;
            color: var(--primary);
            flex-shrink: 0;
        }
        .whisper-model-name {
            font-size: 0.98rem;
            font-weight: 600;
            color: var(--text);
            min-width: 60px;
        }
        .whisper-model-status {
            font-size: 0.93rem;
            font-weight: 400;
            color: var(--text-muted);
            margin-left: 4px;
        }
        .whisper-model-status.downloaded {
            color: var(--primary);
        }
        .whisper-radio {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }
        .whisper-model-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .whisper-btn-delete {
            background: #e0e7ef;
            color: #c0392b;
            font-size: 0.98rem;
            font-weight: 600;
            border-radius: 8px;
            padding: 0.4em 1.1em;
            border: none;
            cursor: pointer;
            transition: background 0.18s, color 0.18s;
        }
        .whisper-btn-delete:hover {
            background: #fbeaea;
            color: #a8231a;
        }
        .whisper-empty {
            color: var(--text-muted);
            font-size: 1.08rem;
            text-align: center;
            margin-top: 1.5rem;
        }
        @media (max-width: 700px) {
            .whisper-section { padding: 1.1rem 0.2rem; }
            .whisper-model-card { flex-direction: column; align-items: flex-start; gap: 8px; padding: 0.8rem 0.5rem; }
        }
        #subtitleOverlay {
            position: absolute;
            left: 0; right: 0; bottom: 8%;
            width: 100%;
            text-align: center;
            color: #fff;
            font-size: 2.1rem;
            font-weight: 700;
            text-shadow: 0 2px 8px #000a, 0 0 2px #000a;
            pointer-events: none;
            z-index: 10;
            padding: 0 2vw;
            line-height: 1.25;
            transition: opacity 0.2s;
        }
    </style>
</head>
<body>
<header>
    <nav>
        <button class="menu-btn active" type="button">Редактор</button>
        <button class="menu-btn" type="button">Настройки</button>
    </nav>
</header>
<main>
    <div class="container">
        <section id="editorPanel">
            <div id="dropzone" class="dropzone --wails-drop-target" tabindex="0" role="button" aria-label="Перетащите файл или нажмите для выбора">
                <span>Перетащите видеофайл сюда<br>или нажмите, чтобы выбрать</span>
            </div>
            <input id="fileInput" type="file" accept="video/*" class="sr-only"/>
            <video id="video" controls style="display:none;" tabindex="0"></video>
            <div id="subtitleOverlay" style="display:none;"></div>
            <p id="videoTitle" style="display:none; margin-top:1rem; font-weight:500; text-align:center;"></p>
            <div id="controls" class="controls" style="display:none;">
                <button id="openBtn" class="btn" type="button">Открыть</button>
                <button id="playPauseBtn" class="btn" type="button">▶</button>
                <button id="subBtn" class="btn" type="button">Создать субтитры</button>
                <button id="exportBtn" class="btn" type="button" style="display:none;">Экспорт SRT</button>
                <button id="closeMediaBtn" class="btn btn--danger" type="button">Закрыть медиа</button>
            </div>
        </section>
        <section id="settingsPanel" style="display:none; background:none; box-shadow:none; padding:0; max-width:none;">
            <div class="whisper-section">
                <div class="whisper-section-title">Доступные модели для скачивания</div>
                <div class="whisper-download-row">
                    <label for="modelSelect">Модель:</label>
                    <select id="modelSelect"></select>
                    <button id="downloadBtn" class="whisper-download-btn">Скачать</button>
                    <div id="downloadProgress" class="whisper-progress"></div>
                </div>
            </div>
            <hr class="whisper-divider" />
            <div class="whisper-section">
                <div class="whisper-section-title">Скачанные модели</div>
                <div id="modelsList" class="whisper-models-list"></div>
                <div id="emptyList" class="whisper-empty" style="display:none;"></div>
            </div>
        </section>
    </div>
</main>
<!-- Кастомный модал для подтверждения удаления -->
<div id="deleteConfirmModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:#0005; z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; color:#222; border-radius:12px; box-shadow:0 4px 24px #0003; padding:2rem 2.5rem; min-width:320px; max-width:90vw; text-align:center;">
    <div id="deleteConfirmText" style="font-size:1.1rem; margin-bottom:1.5rem;"></div>
    <button id="deleteConfirmYes" style="background:#e74c3c; color:#fff; border:none; border-radius:8px; padding:0.5em 1.5em; font-size:1rem; margin-right:1.2em; cursor:pointer;">Удалить</button>
    <button id="deleteConfirmNo" style="background:#e0e7ef; color:#222; border:none; border-radius:8px; padding:0.5em 1.5em; font-size:1rem; cursor:pointer;">Отмена</button>
  </div>
</div>
<script>
    const $ = id => document.getElementById(id);
    const video = $("video"), openBtn = $("openBtn"), playPauseBtn = $("playPauseBtn"),
          fileInput = $("fileInput"), dropzone = $("dropzone"), subBtn = $("subBtn"),
          exportBtn = $("exportBtn"), controls = $("controls"), closeBtn = $("closeMediaBtn"),
          videoTitle = $("videoTitle");
    let selectedModel = localStorage.getItem("whisperModel") || "base", downloadProgress = {}, currentFilePath = null;
    const show = el => el.style.display = "", hide = el => el.style.display = "none";
    playPauseBtn.addEventListener("click", () => video.paused ? video.play() : video.pause());
    video.addEventListener("play", () => playPauseBtn.textContent = "⏸");
    video.addEventListener("pause", () => playPauseBtn.textContent = "▶");
    openBtn.addEventListener("click", async () => {
        if (window.runtime && window.runtime.OpenFileDialog) {
            const result = await window.runtime.OpenFileDialog({
                title: "Выберите видео",
                filters: [{ name: "Видео", extensions: ["mp4", "mkv", "avi", "mov", "wmv", "flv", "webm"] }]
            });
            if (result && result.length > 0) {
                loadVideo({ path: result[0], name: result[0].split(/[\\/]/).pop() });
            }
        } else {
            fileInput.click();
        }
    });
    fileInput.addEventListener("change", async e => {
        if (e.target.files[0]) {
            // В Wails приложении нужно использовать Wails API для получения пути к файлу
            if (window.runtime && window.runtime.OpenFileDialog) {
                const result = await window.runtime.OpenFileDialog({
                    title: "Выберите видео",
                    filters: [{ name: "Видео", extensions: ["mp4", "mkv", "avi", "mov", "wmv", "flv", "webm"] }]
                });
                if (result && result.length > 0) {
                    loadVideo({ path: result[0], name: result[0].split(/[\\/]/).pop() });
                }
            } else {
                // Fallback для браузера (не будет работать с Wails API)
                console.warn("Wails API недоступен, файл не будет работать с субтитрами");
                loadVideo(e.target.files[0]);
            }
        }
    });

    // === OnFileDrop: Регистрируем ПЕРВЫМ ===
    if (window.runtime && window.runtime.OnFileDrop) {
        console.log('OnFileDrop handler registered');
        
        // Dropzone only - основной обработчик
        window.runtime.OnFileDrop((x, y, paths) => {
            console.log('[OnFileDrop DROPZONE] called, x:', x, 'y:', y, 'paths:', paths);
            if (paths && paths.length > 0) {
                console.log('Processing dropped file:', paths[0]);
                loadVideo({ path: paths[0], name: paths[0].split(/[\\/]/).pop() });
            } else {
                console.warn('OnFileDrop called but no paths provided');
            }
        }, true);
        
        // Global handler для диагностики
        window.runtime.OnFileDrop((x, y, paths) => {
            console.log('[OnFileDrop GLOBAL] called, x:', x, 'y:', y, 'paths:', paths);
            if (paths && paths.length > 0) {
                console.log('Global handler processing file:', paths[0]);
                loadVideo({ path: paths[0], name: paths[0].split(/[\\/]/).pop() });
            }
        }, false);
        
        // Добавляем стандартный drop как fallback
        dropzone.addEventListener("drop", e => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Standard drop event on dropzone');
            
            // Если Wails OnFileDrop не сработал, попробуем использовать стандартный drop
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                console.log('File dropped via standard API:', file.name);
                
                // Показываем сообщение о том, что нужно использовать кнопку "Открыть"
                showErrorDialog(`Файл "${file.name}" перетащен, но drag & drop не работает корректно. Пожалуйста, используйте кнопку "Открыть" для выбора файла.`);
            }
        });
        
    } else {
        console.warn('Wails OnFileDrop not available, using standard drop');
        // Fallback для браузера
        dropzone.addEventListener("drop", e => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Standard drop handler called');
            if (e.dataTransfer.files[0]) {
                console.log('File dropped:', e.dataTransfer.files[0].name);
                // В браузере мы не можем получить полный путь, но можем показать предупреждение
                showErrorDialog("В браузерном режиме drag & drop не поддерживается. Используйте кнопку 'Открыть'.");
            }
        });
    }
    
    // Обработчики для визуальной обратной связи
    ["dragenter","dragover"].forEach(ev => {
        dropzone.addEventListener(ev, e => { 
            e.preventDefault(); 
            e.stopPropagation();
            dropzone.classList.add("dragover"); 
        });
    });
    
    ["dragleave"].forEach(ev => {
        dropzone.addEventListener(ev, e => { 
            e.preventDefault(); 
            e.stopPropagation();
            dropzone.classList.remove("dragover"); 
        });
    });
    
    // Обработчик клика по dropzone
    dropzone.addEventListener("click", () => {
        console.log('Dropzone clicked, opening file dialog');
        fileInput.click();
    });
    function loadVideo(file) {
        console.log('loadVideo called with file:', file, 'file.path:', file.path, 'file.name:', file.name);
        
        // Проверяем, есть ли путь к файлу
        if (!file.path) {
            console.error('File path is missing! File object:', file);
            showErrorDialog("Ошибка: не удалось получить путь к файлу. Попробуйте выбрать файл через кнопку 'Открыть'.");
            return;
        }
        
        currentFilePath = file.path;
        console.log('currentFilePath set to:', currentFilePath);
        
        // Проверяем, что путь не пустой
        if (!currentFilePath || currentFilePath.trim() === '') {
            console.error('currentFilePath is empty or invalid:', currentFilePath);
            showErrorDialog("Ошибка: неверный путь к файлу.");
            return;
        }
        
        // Проверяем расширение файла
        const fileName = file.name || file.path.split(/[\\/]/).pop();
        const fileExtension = fileName.toLowerCase().split('.').pop();
        const supportedFormats = ['mp4', 'mkv', 'avi', 'mov', 'wmv', 'flv', 'webm'];
        
        if (!supportedFormats.includes(fileExtension)) {
            console.warn('Unsupported file format:', fileExtension);
            showErrorDialog(`Неподдерживаемый формат файла: .${fileExtension}. Поддерживаемые форматы: ${supportedFormats.join(', ')}`);
            return;
        }
        
        try {
            console.log('Setting video source to:', currentFilePath);
            video.src = currentFilePath;
            videoTitle.textContent = fileName;
            
            // Добавляем обработчик ошибок для видео
            video.onerror = (e) => {
                console.error('Video loading error:', e);
                console.error('Video error details:', video.error);
                showErrorDialog("Ошибка загрузки видео. Проверьте, что файл существует и поддерживается.");
                // Сбрасываем состояние
                currentFilePath = null;
                hide(video);
                hide(videoTitle);
                hide(controls);
                show(dropzone);
            };
            
            video.onloadeddata = () => {
                console.log('Video loaded successfully, duration:', video.duration);
                show(video); 
                show(videoTitle); 
                show(controls); 
                hide(dropzone);
            };
            
            video.onloadstart = () => {
                console.log('Video loading started');
            };
            
            video.oncanplay = () => {
                console.log('Video can start playing');
            };
            
        } catch (error) {
            console.error('Error in loadVideo:', error);
            showErrorDialog("Ошибка при загрузке видео: " + error.message);
            // Сбрасываем состояние при ошибке
            currentFilePath = null;
        }
    }
    function showErrorDialog(message) {
        console.log("showErrorDialog called with:", message);
        if (!message) return;
        // Если есть Wails runtime, используем MessageDialog (если появится в будущем)
        if (window.runtime && window.runtime.MessageDialog) {
            window.runtime.MessageDialog({
                type: 'error',
                title: 'Ошибка',
                message: message
            });
        } else {
            // Кастомный модал поверх всего
            let modal = document.getElementById('errorModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'errorModal';
                modal.style = 'position:fixed;left:0;top:0;width:100vw;height:100vh;background:#0007;z-index:99999;display:flex;align-items:center;justify-content:center;';
                modal.innerHTML = `<div style=\"background:#fff;color:#222;border-radius:12px;box-shadow:0 4px 24px #0003;padding:2rem 2.5rem;min-width:320px;max-width:90vw;text-align:center;\">\n                <div id=\"errorModalText\" style=\"font-size:1.1rem;margin-bottom:1.5rem;\"></div>\n                <button id=\"errorModalOk\" style=\"background:#4fa3ff;color:#fff;border:none;border-radius:8px;padding:0.5em 1.5em;font-size:1rem;cursor:pointer;\">OK</button>\n            </div>`;
                document.body.appendChild(modal);
            }
            document.getElementById('errorModalText').textContent = message;
            modal.style.display = 'flex';
            // Усиливаю обработчик: всегда переназначаю
            const okBtn = document.getElementById('errorModalOk');
            if (okBtn) {
                okBtn.onclick = () => { modal.style.display = 'none'; };
            }
        }
    }
    subBtn.addEventListener("click", async () => {
        console.log("currentFilePath on subBtn click:", currentFilePath);
        
        // Проверяем, выбран ли файл
        if (!currentFilePath) { 
            showErrorDialog("Сначала выберите видео! Используйте кнопку 'Открыть' или перетащите файл.");
            return; 
        }
        
        // Проверяем, что файл действительно существует
        if (!currentFilePath.trim()) {
            showErrorDialog("Ошибка: путь к файлу пустой. Попробуйте выбрать файл заново.");
            return;
        }
        
        console.log("Starting subtitle generation for file:", currentFilePath);
        
        subBtn.disabled = true; 
        subBtn.textContent = "Генерация...";
        
        const overlay = document.getElementById("subtitleOverlay");
        overlay.style.display = "";
        
        let chunkSec = 10;
        let lang = "ru";
        let model = selectedModel;
        let duration = Math.floor(video.duration);
        let currentChunk = 0;
        let subtitles = [];
        
        function showSubtitle(text) {
            overlay.textContent = text;
            overlay.style.opacity = text ? "1" : "0";
        }
        
        async function fetchAndShowChunk(chunkIdx) {
            let start = chunkIdx * chunkSec;
            let end = Math.min(start + chunkSec, duration);
            if (start >= duration) { 
                showSubtitle(""); 
                return; 
            }
            
            console.log(`Generating chunk ${chunkIdx}: ${start}s - ${end}s`);
            
            try {
                let srt = await window.go.main.App.GenerateSubtitlesChunk(currentFilePath, lang, model, start, end);
                let text = srt.split("\n").filter(line => line && !/^\d+$/.test(line) && !/^\d{2}:\d{2}/.test(line)).join(" ");
                subtitles[chunkIdx] = text;
                showSubtitle(text);
                console.log(`Chunk ${chunkIdx} generated successfully`);
            } catch (err) {
                console.error(`Error generating chunk ${chunkIdx}:`, err);
                showErrorDialog("Ошибка генерации субтитров: " + (err && err.message ? err.message : err));
                showSubtitle("[Ошибка субтитров]");
            }
        }
        
        let interval = setInterval(() => {
            if (video.paused || video.ended) return;
            let chunkIdx = Math.floor(video.currentTime / chunkSec);
            if (subtitles[chunkIdx] === undefined) {
                fetchAndShowChunk(chunkIdx);
            } else {
                showSubtitle(subtitles[chunkIdx]);
            }
        }, 500);
        
        video.addEventListener("ended", () => { 
            showSubtitle(""); 
            clearInterval(interval); 
        });
        
        closeBtn.addEventListener("click", () => { 
            showSubtitle(""); 
            clearInterval(interval); 
            overlay.style.display = "none"; 
        });
        
        // Генерируем первый чанк
        try {
            await fetchAndShowChunk(0);
        } catch (error) {
            console.error("Error generating first chunk:", error);
            showErrorDialog("Ошибка при запуске генерации субтитров: " + error.message);
        }
        
        subBtn.disabled = false; 
        subBtn.textContent = "Создать субтитры";
    });
    exportBtn.addEventListener("click", () => {
        if (!currentFilePath) return;
        const blob = new Blob([currentFilePath], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "subtitles.srt";
        a.click();
    });
    closeBtn.addEventListener("click", () => {
        video.pause(); video.removeAttribute("src"); video.load();
        hide(video); hide(videoTitle); hide(exportBtn); hide(controls);
        dropzone.querySelector("span").innerHTML = "Перетащите видеофайл сюда<br>или нажмите, чтобы выбрать";
        show(dropzone);
        currentFilePath = null; fileInput.value = "";
    });
    window.runtime?.EventsOn?.("modelDownloadProgress", data => {
        downloadProgress[data.name] = data.percent;
        const bar = document.getElementById(`progress_${data.name}`), btn = document.getElementById(`dl_${data.name}`);
        if (bar) { bar.style.width = data.percent + "%"; bar.textContent = data.percent + "%"; }
        if (data.percent >= 100 && btn) { btn.textContent = "✓"; btn.disabled = true; bar.style.display = "none"; }
    });

    // --- Переключение вкладок ---
    const editorTab = document.querySelector('.menu-btn.active');
    const settingsTab = document.querySelectorAll('.menu-btn')[1];
    const editorPanel = document.getElementById('editorPanel');
    const settingsPanel = document.getElementById('settingsPanel');
    function showEditor() {
        editorPanel.style.display = '';
        settingsPanel.style.display = 'none';
        editorTab.classList.add('active');
        settingsTab.classList.remove('active');
    }
    function showSettings() {
        editorPanel.style.display = 'none';
        settingsPanel.style.display = '';
        editorTab.classList.remove('active');
        settingsTab.classList.add('active');
        loadModels();
    }
    editorTab.addEventListener('click', showEditor);
    settingsTab.addEventListener('click', showSettings);

    // --- JS: Whisper Settings ---
    let availableModels = [];
    let downloadedModels = [];
    let activeModel = localStorage.getItem('whisperModel') || null;
    let downloading = false;
    let downloadingModel = null;

    async function loadModels() {
        const modelSelect = document.getElementById('modelSelect');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadProgressDiv = document.getElementById('downloadProgress');
        const modelsListDiv = document.getElementById('modelsList');
        const emptyListDiv = document.getElementById('emptyList');
        modelSelect.innerHTML = '';
        modelsListDiv.innerHTML = '';
        emptyListDiv.style.display = 'none';
        
        try {
            const all = await window.go.main.App.ListModels();
            // Сортируем по expectedSize (байты)
            availableModels = all.filter(m => !m.local).sort((a, b) => (a.expectedSize||a.size||0) - (b.expectedSize||b.size||0));
            downloadedModels = all.filter(m => m.local).sort((a, b) => (a.expectedSize||a.size||0) - (b.expectedSize||b.size||0));
            
            // --- Render download block ---
            if (availableModels.length === 0) {
                modelSelect.disabled = true;
                downloadBtn.disabled = true;
                downloadBtn.textContent = 'Нет новых моделей';
            } else {
                modelSelect.disabled = false;
                downloadBtn.disabled = false;
                
                // Группируем модели по размеру для лучшей организации
                const modelGroups = {
                    'tiny': availableModels.filter(m => m.name.includes('tiny')),
                    'base': availableModels.filter(m => m.name.includes('base') && !m.name.includes('distil')),
                    'small': availableModels.filter(m => m.name.includes('small')),
                    'medium': availableModels.filter(m => m.name.includes('medium') && !m.name.includes('distil')),
                    'large': availableModels.filter(m => m.name.includes('large')),
                    'distil': availableModels.filter(m => m.name.includes('distil'))
                };
                
                // Добавляем опции в select с группировкой
                Object.entries(modelGroups).forEach(([groupName, models]) => {
                    if (models.length > 0) {
                        // Добавляем разделитель для группы
                        const groupOpt = document.createElement('option');
                        groupOpt.disabled = true;
                        groupOpt.textContent = `--- ${groupName.toUpperCase()} ---`;
                        modelSelect.appendChild(groupOpt);
                        
                        // Добавляем модели группы
                        models.forEach(m => {
                            const opt = document.createElement('option');
                            opt.value = m.name;
                            const size = formatModelSize(m.expectedSize||m.size);
                            const lang = m.name.includes('.en') ? ' (EN)' : m.name.includes('distil') ? ' (Fast)' : '';
                            opt.textContent = `${m.name}${lang} (${size})`;
                            modelSelect.appendChild(opt);
                        });
                    }
                });
                
                modelSelect.value = availableModels[0].name;
                downloadBtn.textContent = 'Скачать';
            }
            
            // --- Download button logic ---
            let selectedModel = modelSelect.value;
            modelSelect.onchange = e => { selectedModel = e.target.value; };
            downloadBtn.onclick = async () => {
                if (!selectedModel || downloading) return;
                downloading = true;
                downloadBtn.disabled = true;
                downloadBtn.textContent = 'Загрузка...';
                downloadProgressDiv.style.display = 'block';
                downloadProgressDiv.textContent = '0%';
                try {
                    await window.go.main.App.DownloadModel(selectedModel);
                } catch (e) {
                    downloadProgressDiv.textContent = 'Ошибка загрузки';
                } finally {
                    downloading = false;
                    loadModels();
                    downloadProgressDiv.style.display = 'none';
                }
            };
            
            // --- Render downloaded models ---
            if (downloadedModels.length === 0) {
                emptyListDiv.style.display = 'block';
                emptyListDiv.textContent = 'Нет загруженных моделей Whisper';
                return;
            }
            emptyListDiv.style.display = 'none';
            
            // Группируем скачанные модели по размеру
            const downloadedGroups = {
                'tiny': downloadedModels.filter(m => m.name.includes('tiny')),
                'base': downloadedModels.filter(m => m.name.includes('base') && !m.name.includes('distil')),
                'small': downloadedModels.filter(m => m.name.includes('small')),
                'medium': downloadedModels.filter(m => m.name.includes('medium') && !m.name.includes('distil')),
                'large': downloadedModels.filter(m => m.name.includes('large')),
                'distil': downloadedModels.filter(m => m.name.includes('distil'))
            };
            
            Object.entries(downloadedGroups).forEach(([groupName, models]) => {
                if (models.length > 0) {
                    // Добавляем заголовок группы
                    const groupHeader = document.createElement('div');
                    groupHeader.className = 'whisper-group-header';
                    groupHeader.textContent = groupName.toUpperCase();
                    modelsListDiv.appendChild(groupHeader);
                    
                    // Добавляем модели группы
                    models.forEach(model => {
                        const card = document.createElement('div');
                        card.className = 'whisper-model-card';
                        
                        // Левая часть: иконка + radio + имя + статус
                        const info = document.createElement('div');
                        info.className = 'whisper-model-info';
                        
                        const icon = document.createElement('span');
                        icon.className = 'whisper-model-icon';
                        icon.innerHTML = `<svg fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><rect x='3' y='7' width='18' height='13' rx='3'/><path d='M16 3v4M8 3v4'/></svg>`;
                        
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = 'activeModel';
                        radio.value = model.name;
                        radio.checked = activeModel === model.name;
                        radio.className = 'whisper-radio';
                        radio.onchange = () => {
                            activeModel = model.name;
                            localStorage.setItem('whisperModel', activeModel);
                            loadModels();
                        };
                        
                        const name = document.createElement('span');
                        name.textContent = model.filename || model.name;
                        name.className = 'whisper-model-name';
                        
                        const status = document.createElement('span');
                        status.className = 'whisper-model-status downloaded';
                        status.innerHTML = formatModelSize(model.expectedSize||model.size);
                        
                        info.appendChild(icon);
                        info.appendChild(radio);
                        info.appendChild(name);
                        info.appendChild(status);
                        
                        // Правая часть: удалить
                        const actions = document.createElement('div');
                        actions.className = 'whisper-model-actions';
                        
                        const btnDelete = document.createElement('button');
                        btnDelete.className = 'whisper-btn-delete';
                        btnDelete.textContent = 'Удалить';
                        btnDelete.onclick = async (e) => {
                            e.stopPropagation();
                            const confirmed = await customConfirm(`Удалить модель ${model.filename || model.name}?`);
                            if (confirmed) {
                                await window.go.main.App.DeleteModel(model.name);
                                loadModels();
                            }
                        };
                        
                        actions.appendChild(btnDelete);
                        card.appendChild(info);
                        card.appendChild(actions);
                        modelsListDiv.appendChild(card);
                    });
                }
            });
        } catch (e) {
            emptyListDiv.style.display = 'block';
            emptyListDiv.textContent = 'Ошибка загрузки моделей Whisper';
        }
    }
    // Форматирование размера модели (MB/GB)
    function formatModelSize(bytes) {
        if (!bytes) return '';
        if (bytes >= 1024*1024*1024) return (bytes/1024/1024/1024).toFixed(1) + ' GB';
        return (bytes/1024/1024).toFixed(0) + ' MB';
    }
    // --- Прогресс загрузки ---
    window.runtime && window.runtime.EventsOn && window.runtime.EventsOn("modelDownloadProgress", data => {
        const downloadProgressDiv = document.getElementById('downloadProgress');
        if (!downloadProgressDiv) return;
        if (data.name === document.getElementById('modelSelect').value) {
        downloadProgressDiv.style.display = 'block';
        downloadProgressDiv.textContent = data.percent + '%';
        if (data.percent >= 100) {
                downloadProgressDiv.style.display = 'none';
            }
        }
    });
    // --- Кастомный confirm ---
    function customConfirm(message) {
        return new Promise(resolve => {
            const modal = document.getElementById('deleteConfirmModal');
            const text = document.getElementById('deleteConfirmText');
            const yes = document.getElementById('deleteConfirmYes');
            const no = document.getElementById('deleteConfirmNo');
            text.textContent = message;
            modal.style.display = 'flex';
            function cleanup(result) {
                modal.style.display = 'none';
                yes.removeEventListener('click', onYes);
                no.removeEventListener('click', onNo);
                resolve(result);
            }
            function onYes() { cleanup(true); }
            function onNo() { cleanup(false); }
            yes.addEventListener('click', onYes);
            no.addEventListener('click', onNo);
        });
    }
</script>
</body>
</html>